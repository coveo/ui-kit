import fs from 'node:fs';
import path from 'node:path';
import {fileURLToPath} from 'node:url';
import colors from '../../../utils/ci/colors.mjs';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const componentsDir = path.resolve(__dirname, '../src/components');
const outputFile = path.resolve(
  __dirname,
  '../src/utils/custom-element-tags.ts'
);

/**
 * Extracts custom element tag names from component files.
 * Supports both:
 * - Lit components: @customElement('tag-name')
 * - Stencil components: @Component({tag: 'tag-name'})
 */
function extractCustomElementTags() {
  const tags = new Set();

  function scanDirectory(dir) {
    const entries = fs.readdirSync(dir, {withFileTypes: true});

    for (const entry of entries) {
      const fullPath = path.join(dir, entry.name);

      if (entry.isDirectory()) {
        scanDirectory(fullPath);
      } else if (
        entry.isFile() &&
        (entry.name.endsWith('.ts') || entry.name.endsWith('.tsx')) &&
        !entry.name.includes('.spec.') &&
        !entry.name.includes('.stories.') &&
        !entry.name.includes('.e2e.')
      ) {
        const content = fs.readFileSync(fullPath, 'utf-8');

        // Match Lit decorator: @customElement('tag-name')
        const litMatches = content.matchAll(
          /@customElement\(['"]([^'"]+)['"]\)/g
        );
        for (const match of litMatches) {
          tags.add(match[1]);
        }

        // Match Stencil decorator: @Component({tag: 'tag-name', ...})
        const stencilMatches = content.matchAll(
          /@Component\([^)]*tag:\s*['"]([^'"]+)['"]/g
        );
        for (const stencilMatch of stencilMatches) {
          tags.add(stencilMatch[1]);
        }
      }
    }
  }

  scanDirectory(componentsDir);
  return Array.from(tags).sort();
}

/**
 * Generates a TypeScript file with a set of all custom element tags.
 */
export function generateCustomElementTags() {
  console.log(colors.blue('Extracting custom element tags...'));

  const tags = extractCustomElementTags();

  console.log(colors.green(`Found ${tags.length} custom element tags`));

  const fileContent = `// Auto-generated file - DO NOT EDIT
// This file is generated by scripts/generate-custom-element-tags.mjs

/**
 * Set of all custom element tags defined in the Atomic library.
 * This is generated at build time from @customElement and @Component decorators.
 */
export const ATOMIC_CUSTOM_ELEMENT_TAGS = new Set<string>([
${tags.map((tag) => `  '${tag}',`).join('\n')}
]);
`;

  fs.writeFileSync(outputFile, fileContent, 'utf-8');
  console.log(colors.green(`Generated ${outputFile}`));
}

// Run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  generateCustomElementTags();
}
