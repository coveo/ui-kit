// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/typescript-node
{
  "name": "Coveo UI Kit",
  // Use Node.js 22 to match package.json engines requirement
  "image": "mcr.microsoft.com/devcontainers/typescript-node:1-22-bookworm",

  // Features to add to the dev container for better caching and tooling
  "features": {
    "ghcr.io/devcontainers/features/github-cli:1": {},
    "ghcr.io/devcontainers/features/node:1": {
      "nodeGypDependencies": true,
      "version": "22"
    }
  },

  // Forward common development ports
  "forwardPorts": [3000, 3333, 4000, 8080, 9001],
  "portsAttributes": {
    "3000": {
      "label": "Atomic Dev Server",
      "onAutoForward": "notify"
    },
    "3333": {
      "label": "Storybook",
      "onAutoForward": "notify"
    }
  },

  // Use updateContentCommand for prebuilds - runs during prebuild creation/update
  // This significantly reduces time-to-code by pre-installing and building in the prebuild
  "updateContentCommand": "bash -c 'npm ci --prefer-offline --no-audit --progress=false && npm run build'",

  // Fast post-prebuild setup - only runs essential commands after prebuild
  "postCreateCommand": "npm run postinstall",

  // Configure VS Code for optimal development experience
  "customizations": {
    "vscode": {
      "extensions": [
        "biomejs.biome",
        "ms-vscode.vscode-typescript-next",
        "ms-playwright.playwright",
        "vitest.explorer",
        "ms-vscode.vscode-json",
        "redhat.vscode-yaml",
        "streetsidesoftware.code-spell-checker",
        "GitHub.copilot",
        "GitHub.copilot-chat",
        "salesforce.salesforcedx-vscode-lwc",
        "salesforce.salesforcedx-vscode-apex"
      ],
      "settings": {
        "typescript.preferences.quoteStyle": "single",
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "biomejs.biome",
        "editor.codeActionsOnSave": {
          "source.organizeImports": "explicit",
          "source.fixAll": "explicit"
        },
        "files.watcherExclude": {
          "**/node_modules/**": true,
          "**/dist/**": true,
          "**/build/**": true
        },
        "search.exclude": {
          "**/node_modules": true,
          "**/dist": true,
          "**/build": true,
          "**/*.lock": true
        }
      }
    }
  },

  // Environment variables for faster builds and better caching
  "containerEnv": {
    "CI": "true",
    "NODE_OPTIONS": "--max-old-space-size=6144",
    "NPM_CONFIG_PREFER_OFFLINE": "true",
    "NPM_CONFIG_AUDIT": "false",
    "NPM_CONFIG_PROGRESS": "false",
    "NPM_CONFIG_FUND": "false",
    "NPM_CONFIG_UPDATE_NOTIFIER": "false",
    "PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD": "1"
  },

  // Mount node_modules as a named volume for better performance
  "mounts": [
    "source=ui-kit-node_modules,target=${containerWorkspaceFolder}/node_modules,type=volume"
  ]
}
