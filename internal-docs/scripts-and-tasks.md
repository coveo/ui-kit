# Scripts and tasks

When adding packages or changing scripts, make sure that scripts for each `package.json` follow these rules:

## Nesting

Some scripts may be nested under other scripts using the colon (`:`) symbol. This can interchangeably be used to mean either:

- The nested script is a fragment of the parent script.
  - E.g.:
    ```json
    {
      "build": "npm run build:bundles && npm run build:definitions",
      "build:bundles": "...",
      "build:definitions": "..."
    }
    ```
- The nested script is an alternative configuration of the parent script.
  - E.g.:
    ```json
    {
      "e2e": "cypress run --browser chrome",
      "e2e:firefox": "cypress run --browser firefox",
      "e2e:watch": "cypress open --browser chrome --e2e"
    }
    ```

## `build` script

- Generates all the files needed for a dependent project to run.
- Doesn't expect another script from the same project to be run before this script.
- If the build fails, exits with an error.

### Caching builds

When running tasks using [Turborepo](https://turbo.build/), packages and dependencies are automatically built if needed. To avoid the need to run tasks without Turborepo, builds are [cached](https://turbo.build/repo/docs/core-concepts/caching) and should only be re-built when their source files are changed.

By default, when adding new packages, builds are cached based on the configuration in [`turbo.json`](/turbo.json). The `build` task is configured with dependency resolution (`"dependsOn": ["^build"]`) and output caching.

When adding new packages, they will automatically inherit the caching behavior from the root configuration. However, if you need to customize caching for a specific package, you can:

1. **Customize caching at the package level** by adding a `turbo.json` file in the package directory with package-specific configuration:

   ```json
   {
     "extends": ["//"],
     "tasks": {
       "build": {
         "outputs": ["custom-dist/**", "special-output/**"]
       }
     }
   }
   ```

2. **Modify the root `turbo.json`** if the changes should apply globally:

   - **Inputs**: Turborepo automatically detects input files, but you can customize which files invalidate the cache using the `inputs` field.
   - **Outputs**: Define which files are generated by the build task using the `outputs` field. The default outputs are defined in the root [`turbo.json`](/turbo.json).
   - **Dependencies**: Configure task dependencies using `dependsOn` to ensure proper build order.

3. **Package.json scripts**: Each package should have a `build` script that defines how to build the package:

   ```json
   {
     "scripts": {
       "build": "npm run build:bundles && npm run build:definitions",
       "build:bundles": "node esbuild.mjs",
       "build:definitions": "tsc -p tsconfig.build.json -d --emitDeclarationOnly --declarationDir dist/definitions"
     }
   }
   ```

4. **Running builds**: Use Turborepo commands to run builds:
   - `npx turbo build` - Build all packages
   - `npx turbo build --filter=package-name` - Build a specific package
   - `npx turbo build --filter=...package-name` - Build a package and its dependencies

## `dev` script

- Generates all the files needed for a dependent project to run.
- Doesn't expect another script from the same project to be run before this script.
- Automatically re-runs when there's a code change in the project or its dependencies.
- Doesn't exit until the user chooses to.
- May serve the project with a URL.

## `prod` script

- Expects the `build` script to be run before this script.
- Runs the build.
- May serve the project with a URL.

## `test` script

- Runs all unit tests and/or integration tests for the project.
- **Doesn't** run end-to-end tests.
- Doesn't expect another script from the same project to be run before this script.
- If all tests pass, exits without an error.
- If any test fails, exits with an error.

## `test:watch` script

Does the same thing as the `test` script, except:

- Re-runs tests when there's a code change in the project.
- Doesn't exit until the user chooses to.

## `e2e` script

- Does the same thing as the `test` script, but runs end-to-end tests instead.

## `e2e:watch` script

- Does the same thing as the `test:watch` script, but runs end-to-end tests instead.

### `publish:npm` script

- Publishes the package to NPM.

### `publish:sfdx` script

- Publishes the package to the current Salesforce dev hub.

## `promote:*` script

- Promotes a remote package.
- Should be run after QA validations.

### `promote:npm:latest` script

- Promotes an NPM package to `latest`.

### `promote:sfdx` script

- Promotes a package in the current Salesforce dev hub.

## `lint:check` script

- Doesn't expect another script from the same project to be run before this script.
- If there's no linting errors, exits without an error.
- If there's any linting error, exits with an error.

## `lint:fix` script

- Checks for linting errors and tries to fix them.
