on:
  workflow_call:
    secrets:
      SFDX_AUTH_CLIENT_ID:
        required: true
      SFDX_AUTH_JWT_KEY:
        required: true
jobs:
  e2e-quantic-setup:
    name: 'Setup e2e tests on Quantic'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: ./.github/actions/setup
      - uses: ./.github/actions/setup-sfdx
      - uses: ./.github/actions/e2e-quantic-setup
        with:
          clientid: ${{ secrets.SFDX_AUTH_CLIENT_ID }}
          jwtkey: ${{ secrets.SFDX_AUTH_JWT_KEY }}
  post-scratch-org-links-to-pr:
    name: 'Post Scratch Org Links to PR'
    needs: e2e-quantic-setup
    if: ${{ github.event_name == 'pull_request' }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: ./.github/actions/post-scratch-org-links-on-pr
  e2e-quantic-playwright-test:
    name: 'Run Playwright e2e tests on Quantic'
    needs: e2e-quantic-setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: ./.github/actions/setup
      - uses: ./.github/actions/e2e-quantic-playwright
        with:
          shardIndex: ${{ matrix.shardIndex }}
          shardTotal: ${{ matrix.shardTotal }}
          testsToRun: ${{ needs.prepare-playwright-atomic.outputs.testsToRun }}
  merge-quantic-playwright-reports:
    name: 'Merge Playwright reports'
    environment: PR Artifacts
    if: ${{ !cancelled() }}
    needs:
      - 'e2e-quantic-playwright-test'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: ./.github/actions/setup
      - name: Merge Playwright HTML reports
        uses: ./.github/actions/merge-playwright-reports
        with:
          working-directory: packages/quantic
          artifact-pattern: quantic-blob-report-*
          upload-artifact-name: quantic-playwright-report
      - name: Merge Playwright JSON reports
        uses: ./.github/actions/merge-playwright-json-reports
        with:
          working-directory: packages/quantic
          artifact-pattern: quantic-blob-report-*
          upload-artifact-name: quantic-playwright-report-json
  Publish-Dashboard:
    name: Create playwright-dashboard page
    if: (success() || failure()) && github.event_name == 'schedule' && github.ref == 'refs/heads/master'
    needs: [merge-quantic-playwright-reports]
    runs-on:
      [
        "coveo uid=${{ github.run_id }}-${{ github.run_attempt }}",
        linux,
        arm64,
        ec2,
      ]
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Download artifact
        uses: actions/download-artifact@v4

      - name: Publish google chart
        uses: coveo-platform/actions/playwright-dashboard@playwright-dashboard-v1
        with:
          project_name: "quantic-regression"
          artifact_name: quantic-playwright-report-json
          json_report_name: merged-json-report.json
          filter_report_by_branch: "SFINT-6399"
          filter_report_by_event_type: "pull_request"
          days_in_past: "30"

      - name: Upload Playwright report and charts to S3
        run: |
          aws s3 cp $GITHUB_WORKSPACE/quantic-playwright-report \
          s3://playwright-dashboard-bucket/quantic-regression/quantic-regression-reports/${{ github.run_id }}/ \
          --recursive || true

          aws s3 cp $GITHUB_WORKSPACE/quantic-regression_chart.html \
          s3://playwright-dashboard-bucket/quantic-regression/quantic-regression_chart.html
  e2e-quantic-cleanup:
    if: cancelled() || failure() || success()
    needs:
      - e2e-quantic-playwright-test
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: ./.github/actions/setup
      - uses: ./.github/actions/setup-sfdx
      - run: |
          npx --no-install ts-node scripts/build/delete-org.ts --scratch-org-def-path=./config/lws-disabled-scratch-def.json
          npx --no-install ts-node scripts/build/delete-org.ts --scratch-org-def-path=./config/lws-enabled-scratch-def.json
        shell: bash
        working-directory: ./packages/quantic
