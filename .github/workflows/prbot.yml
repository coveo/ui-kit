name: PR Robot
on:
  pull_request:
  merge_group:
jobs:
  report-size:
    if: github.event_name == 'pull_request'
    name: 'Report bundle size'
    runs-on: ubuntu-latest
    env:
      GITHUB_CREDENTIALS: ${{ secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
        with:
          node-version-file: '.nvmrc'
      - run: npm ci
      - run: npm run pr:report
  lint-check:
    name: 'Check with linter'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - uses: ./.github/actions/setup
      - run: npm run lint:check
  required-jobs:
    if: |
      ${{
        !cancelled () &&
        !contains(needs.*.result, 'failure')
      }}
    needs:
      - 'lint-check'

    runs-on: ubuntu-latest
    steps:
      - run: echo "${${{needs.*.result}}[@]}"
      - run: echo 'All required jobs have passed'
  is-valid:
    if: |
      ${{
        !cancelled () &&
        !contains(needs.*.result, 'failure')
      }}
    name: 'Confirm build is valid'
    needs:
      - 'required-jobs'
    runs-on: ubuntu-latest
    steps:
      - run: echo "${${{needs.*.result}}[@]}"
      - run: |
          success="${{ needs.required-jobs.result == 'success' }}"
          if [[ $success == "true" ]]; then
            echo "Build is valid"
            exit 0
          else
            echo "Build is invalid"
            exit 1
          fi
