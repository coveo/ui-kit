name: Cypress tests Quantic
on: [pull_request]
jobs:
  cypress-run:
    name: Cypress run
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: '--max_old_space_size=4096'
      SFDX_AUTH_JWT_INSTANCE_URL: https://login.salesforce.com
      SFDX_AUTH_JWT_USERNAME: rdaccess@coveo.com
      BRANCH_NAME: ${{ github.ref }}
      SFDX_AUTH_CLIENT_ID: ${{ secrets.SFDX_AUTH_CLIENT_ID }}
      SFDX_AUTH_JWT_KEY: ${{ secrets.SFDX_AUTH_JWT_KEY }}

    steps:
      - uses: actions/checkout@v2
      - name: Setup & Build
        run: |
          npm ci
          npx lerna bootstrap --ci
          npm run build
      - name: Setup Salesforce
        working-directory: packages/quantic
        run: |
          echo "${{ secrets.SFDX_AUTH_JWT_KEY }}" > server.key
          ./node_modules/.bin/sfdx force:auth:jwt:grant --clientid ${{ secrets.SFDX_AUTH_CLIENT_ID }} --jwtkeyfile server.key --username ${{ env.SFDX_AUTH_JWT_USERNAME }} --instanceurl ${{ env.SFDX_AUTH_JWT_INSTANCE_URL }} --setdefaultdevhubusername
          ./node_modules/.bin/ts-node scripts/build/deploy-community.ts --ci
      - uses: cypress-io/github-action@2113e5bc19c45979ba123df6e07256d2aaba9a33
        name: Cypress tests
        with:
          working-directory: ./packages/quantic
          record: ${{ github.ref == 'refs/heads/master' && true ||  false }}
          install: false

      - uses: actions/upload-artifact@v1
        if: failure()
        with:
          name: cypress-screenshots
          path: packages/quantic/cypress/screenshots

      - name: Delete org
        if: always()
        working-directory: packages/quantic
        run: ./node_modules/.bin/ts-node scripts/build/delete-org.ts