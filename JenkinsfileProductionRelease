node('linux && docker') {
  checkout scm

  withEnv([
    'npm_config_cache=npm-cache',
    'CI=true'
  ]){
    withDockerContainer(image: 'node:14', args: '-u=root') {
      stage('Setup') {
        sh 'npm run setup'
      }

    withDockerContainer(image: 'node:14', args: '-u=root') {
      stage('Bump version') {
        withCredentials([
          usernameColonPassword(credentialsId: 'github-commit-token', variable: 'GH_CREDENTIALS')
        ]) {
          sh 'npm run bump:version'
        }
      }

      stage('Npm publish') {
        withCredentials([
          string(credentialsId: 'NPM_TOKEN', variable: 'NPM_TOKEN')
        ]) {
          sh "echo //registry.npmjs.org/:_authToken=${NPM_TOKEN} > ~/.npmrc"
          sh 'npm run npm:publish || true'
        }
      }
    }

    withDockerContainer(image: '458176070654.dkr.ecr.us-east-1.amazonaws.com/jenkins/deployment_package:v7') {
      stage('Veracode package') {
        sh 'rm -rf veracode && mkdir veracode'

        sh 'mkdir veracode/headless'
        sh 'cp -R packages/headless/src packages/headless/package.json packages/headless/package-lock.json veracode/headless'
      }

      stage('Deployment pipeline upload') {
        sh 'deployment-package package create --with-deploy || true'
      }
    }
  }
}