node('linux && docker') {
  checkout scm

  withEnv(['npm_config_cache=npm-cache', 'CI=true']) {
    withDockerContainer(image: 'node:14', args: '-u=root') {
      stage('Setup') {
        sh 'npm run setup'
      }

      withDockerContainer(image: 'node:14', args: '-u=root') {
        stage('Bump version') {
          withCredentials([
          usernameColonPassword(credentialsId: 'github-commit-token', variable: 'GH_CREDENTIALS')]) {
            sh 'npm run version:graduate'
          }
        }

        stage('Npm publish') {
          withCredentials([
          string(credentialsId: 'NPM_TOKEN', variable: 'NPM_TOKEN')]) {
            sh "echo //registry.npmjs.org/:_authToken=${NPM_TOKEN} > ~/.npmrc"
            sh 'npm run npm:publish || true'
          }
        }
      }
    }
  }